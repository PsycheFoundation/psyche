services:
  psyche-run-owner:
    image: psyche-solana-test-client:latest
    depends_on:
      psyche-solana-test-validator:
        condition: service_healthy
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    env_file:
      - '../../config/client/.env.local'
    volumes:
      - ${CONFIG_PATH:-../../config/solana-test/nano-one-min-clients.toml}:/usr/local/config.toml
      - ./keypairs:/usr/local/keypairs:ro
    entrypoint: ['/bin/sh', '-c', '/bin/run_owner_entrypoint.sh']
    networks:
      - psyche-test-network

  psyche-test-client:
    image: psyche-solana-test-client:latest
    depends_on:
      psyche-run-owner:
        condition: service_completed_successfully
    deploy:
      replicas: ${NUM_REPLICAS:-1}
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    env_file:
      - '../../config/client/.env.local'
    environment:
      - HF_TOKEN=${HF_TOKEN:-}
    volumes:
      - ./keypairs:/usr/local/keypairs:ro
    networks:
      - psyche-test-network

  psyche-solana-test-validator:
    image: psyche-solana-test-validator:latest
    ports:
      - '8899:8899'
      - '8900:8900'
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'AUTHORIZER_ID=$(solana address -k /local/solana-authorizer/target/deploy/psyche_solana_authorizer-keypair.json) && COORDINATOR_ID=$(solana address -k /local/solana-coordinator/target/deploy/psyche_solana_coordinator-keypair.json) && solana account $$AUTHORIZER_ID --url http://localhost:8899 | grep -q "Executable: true" && solana account $$COORDINATOR_ID --url http://localhost:8899 | grep -q "Executable: true" || exit 1',
        ]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s
    networks:
      - psyche-test-network

networks:
  psyche-test-network:
    driver: bridge
