name: Solana integration test base

on:
  workflow_call:
    inputs:
      test-name:
        description: 'Name of the test to run (e.g., test_one_clients_three_epochs_run)'
        required: true
        type: string

jobs:
  solana-integration-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true

      - name: Check initial disk space
        run: |
          echo "Initial disk usage"
          df -h
          echo "Docker info"
          docker info | grep -i "docker root dir" || true

      - uses: nixbuild/nix-quick-install-action@v31
        with:
          nix_conf: |
            download-buffer-size = 524288000
            accept-flake-config = true
            substituters = https://cache.nixos.org/ https://cache.garnix.io/ https://nix-community.cachix.org
            trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      # Step 1: Get Validator Image from cache
      - name: Get Validator Image from cache
        id: cache-validator
        uses: actions/cache/restore@v4
        with:
          path: validator-image.tar.gz
          key: validator-image-${{ runner.os }}-${{ hashFiles('shared/coordinator/src/coordinator.rs', 'architectures/decentralized/solana-coordinator/**/*.rs', 'architectures/decentralized/solana-coordinator/**/*.toml', 'architectures/decentralized/solana-coordinator/Cargo.lock', 'architectures/decentralized/solana-authorizer/**/*.rs', 'architectures/decentralized/solana-authorizer/**/*.toml', 'architectures/decentralized/solana-authorizer/Cargo.lock', 'docker/test/psyche_solana_validator_entrypoint.sh', 'nix/docker.nix', 'flake.lock') }}
          fail-on-cache-miss: true

      - name: Load Validator Image
        run: |
          echo "Loading validator image from cache"
          docker load < validator-image.tar.gz
          docker images | grep psyche-solana-test-validator

          echo "Disk usage after loading validator"
          df -h

      - name: Clean up validator tar file
        run: |
          # Remove the compressed validator image to free up disk space
          rm -f validator-image.tar.gz
          echo "Disk usage after removing validator tar"
          df -h

      # Step 2: Download Solana Test Client No Python Image

      # Wait for Garnix right before downloading from Garnix cache
      - name: Wait for Garnix checks
        uses: ./.github/actions/wait-for-garnix

      - name: Download Solana Test Client No Python Image
        run: |
          echo "Disk space before client build"
          df -h

          # download from Garnix cache
          echo "Attempting to fetch from Garnix cache"
          OUT_PATH=$(nix build .#docker-psyche-solana-test-client-no-python --no-link --print-out-paths)

          # Load the image into Docker
          $OUT_PATH | docker load

          echo "Disk space after client build"
          df -h

      - name: Build run-manager binary
        run: |
          nix build --out-link run-manager .#run-manager
          nix build --out-link _keep_tests_binary .#test-psyche-decentralized-testing-integration_tests

      # Clean Nix store
      - name: Clean after client build
        run: |
          # Clean nix store garbage
          nix-collect-garbage -d
          nix store optimise

          # Remove temp files
          sudo rm -rf /tmp/* 2>/dev/null || true

          echo "Disk space after cleanup"
          df -h

      - name: Verify Docker images exist
        run: |
          echo "Checking for required Docker images"
          docker images
          docker images | grep psyche-solana-test-validator || (echo "ERROR: psyche-solana-test-validator image not found" && exit 1)
          docker images | grep psyche-solana-test-client || (echo "ERROR: psyche-solana-test-client image not found" && exit 1)
          echo "All required images are present"

          echo "Final disk usage before tests"
          df -h

      # Step 4: Run Integration Tests
      - name: Run integration test
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cd architectures/decentralized/testing/ && nix run .#test-psyche-decentralized-testing-integration_tests -- --nocapture "${{ inputs.test-name }}"
