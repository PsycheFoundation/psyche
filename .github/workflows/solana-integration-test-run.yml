name: Solana integration tests run
on:
  push:
    branches: [main]
  pull_request:
    branches: [main, '**']

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # First, build the validator image and cache it
  build-validator:
    permissions:
      contents: read
      actions: write
    uses: ./.github/workflows/solana-build-anchor-programs.yml

  # Then run all tests in parallel, using the cached validator image
  test:
    needs: build-validator
    strategy:
      fail-fast: false
      matrix:
        test-name:
          - test_one_clients_three_epochs_run
          - test_two_clients_three_epochs_run
          - test_client_join_and_get_model_p2p
          - test_rejoining_client_delay
          - disconnect_client
          - drop_a_client_waitingformembers_then_reconnect
          - test_when_all_clients_disconnect_checkpoint_is_hub
          - test_solana_subscriptions
          - test_everybody_leaves_in_warmup
          - test_lost_only_peer_go_back_to_hub_checkpoint
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/solana-integration-test-base.yml
    with:
      test-name: ${{ matrix.test-name }}
    secrets: inherit

  decentralized-integration-python-test:
    runs-on: self-hosted
    timeout-minutes: 60
    needs: build-validator

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Validator Image from cache
        id: cache-validator
        uses: actions/cache/restore@v4
        with:
          path: validator-image.tar.gz
          key: validator-image-${{ runner.os }}-${{ hashFiles('shared/coordinator/src/coordinator.rs', 'architectures/decentralized/solana-coordinator/**/*.rs', 'architectures/decentralized/solana-coordinator/**/*.toml', 'architectures/decentralized/solana-coordinator/Cargo.lock', 'architectures/decentralized/solana-authorizer/**/*.rs', 'architectures/decentralized/solana-authorizer/**/*.toml', 'architectures/decentralized/solana-authorizer/Cargo.lock', 'docker/test/psyche_solana_validator_entrypoint.sh', 'nix/docker.nix', 'flake.lock') }}
          fail-on-cache-miss: true

      - name: Load Validator Image
        run: |
          echo "Loading validator image from cache"
          docker load < validator-image.tar.gz
          docker images | grep psyche-solana-test-validator

          echo "Disk usage after loading validator"
          df -h

      - name: Clean up validator tar file
        run: |
          # Remove the compressed validator image to free up disk space
          rm -f validator-image.tar.gz
          echo "Disk usage after removing validator tar"
          df -h

      - name: Download Solana Test Client Python Image
        run: |
          echo "Disk space before client build"
          df -h

          sleep 500
          # Calculate the derivation hash
          echo "Calculating derivation path"
          DRV_PATH=$(nix eval --raw .#docker-psyche-solana-test-client.drvPath)
          echo "Derivation path: $DRV_PATH"

          OUT_PATH=$(nix derivation show $DRV_PATH | jq -r '.[].outputs.out.path')
          echo "Output path: $OUT_PATH"

          # download from Garnix cache first
          echo "Attempting to fetch from Garnix cache"
          nix-store --realise $OUT_PATH --option substitute true

          # Load the image into Docker
          $OUT_PATH | docker load

          echo "Disk space after client build"
          df -h

      - name: Run decentralized integration test
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          nix develop .#dev-python --command bash -c "cargo test --release --features python,parallelism -p psyche-decentralized-testing --test integration_tests -- --nocapture test_run_with_python"
