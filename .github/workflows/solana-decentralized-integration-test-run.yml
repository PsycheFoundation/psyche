name: Decentralized integration tests in self-hosted Runner

on:
  workflow_dispatch: # Allows manual triggering
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # First, build the validator image and cache it
  build-validator:
    permissions:
      contents: read
      actions: write
    uses: ./.github/workflows/solana-build-anchor-programs.yml

  decentralized-integration-test:
    runs-on: self-hosted
    needs: build-validator

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Validator Image from cache
        id: cache-validator
        uses: actions/cache/restore@v4
        with:
          path: validator-image.tar.gz
          key: validator-image-${{ runner.os }}-${{ hashFiles('architectures/decentralized/solana-coordinator/**/*.rs', 'architectures/decentralized/solana-coordinator/**/*.toml', 'architectures/decentralized/solana-coordinator/Cargo.lock', 'architectures/decentralized/solana-authorizer/**/*.rs', 'architectures/decentralized/solana-authorizer/**/*.toml', 'architectures/decentralized/solana-authorizer/Cargo.lock', 'docker/test/psyche_solana_validator_entrypoint.sh', 'nix/docker.nix', 'flake.lock') }}
          fail-on-cache-miss: true

      - name: Load Validator Image
        run: |
          echo "Loading validator image from cache"
          docker load < validator-image.tar.gz
          docker images | grep psyche-solana-test-validator

          echo "Disk usage after loading validator"
          df -h

      - name: Clean up validator tar file
        run: |
          # Remove the compressed validator image to free up disk space
          rm -f validator-image.tar.gz
          echo "Disk usage after removing validator tar"
          df -h

      # - uses: nixbuild/nix-quick-install-action@v31
      #   with:
      #     nix_conf: |
      #       download-buffer-size = 524288000
      #       accept-flake-config = true
      #       substituters = https://cache.nixos.org/ https://cache.garnix.io/ https://nix-community.cachix.org
      #       trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      # - name: Download image from Garnix cache
      #   run: |
      #     nix build --max-jobs 0 .#docker-psyche-solana-client --no-link --print-out-paths > image-path.txt
      #     IMAGE_PATH=$(cat image-path.txt)
      #     "$IMAGE_PATH" | docker load

      - name: Stop Docker containers
        run: docker stop $(docker ps -aq) || true

      - name: Run decentralized integration test
        run: |
          nix develop --command bash -c "USE_PYTHON=1 just decentralized-integration-tests test_big_model_with_sidecars"
